#!/bin/bash

set -e

ROOT_FOLDER=root_files_in_docker

sudo sysctl vm.overcommit_memory=1
sudo echo never /sys/kernel/mm/transparent_hugepage/enabled
sudo sysctl vm.max_map_count=262144
sudo systemctl daemon-reload

docker compose up -d
sudo chown -R "$USER":"$USER" htdocs
docker compose exec -u root main bash -c "chown -R www-data:www-data /home/www-data/.composer /var/www"
docker compose exec main start

if [[ ! -d $ROOT_FOLDER ]]; then
  docker cp magento2docker_main:/var/www/html/ $ROOT_FOLDER
  rm -rf ${ROOT_FOLDER}/app ${ROOT_FOLDER}/dev ${ROOT_FOLDER}/pub ${ROOT_FOLDER}/composer.json
fi